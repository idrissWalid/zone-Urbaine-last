<script>
  const API_URL = "https://zone-urbaine-vote.onrender.com"; // Ton URL Render

  const payBtn = document.getElementById("payBtn");
  const voteBtn = document.getElementById("voteBtn");
  const resultEl = document.getElementById("result");
  const loader = document.getElementById("loader");
  const btnText = document.getElementById("btnText");
  const phoneInput = document.getElementById("phone");

  let paiementEffectue = false;

  phoneInput.addEventListener("input", () => {
    phoneInput.value = phoneInput.value.replace(/\D/g, '').slice(0, 8);
  });

  // Paiement USSD
  payBtn.addEventListener("click", () => {
    const ussdCode = "*144*2*1*55713380*100#"; // adapte ton code
    window.location.href = `tel:${encodeURIComponent(ussdCode)}`;

    paiementEffectue = true;
    voteBtn.disabled = false;
    resultEl.textContent = "Paiement effectué, vous pouvez maintenant voter.";
    resultEl.classList.remove("text-red-500");
    resultEl.classList.add("text-green-500");
  });

  // Vote pour candidat
  voteBtn.addEventListener("click", async () => {
    if (!paiementEffectue) {
      resultEl.textContent = "Vous devez effectuer le paiement avant de voter.";
      resultEl.classList.add("text-red-500");
      return;
    }

    const phone = phoneInput.value.trim();
    if (phone.length !== 8) {
      resultEl.textContent = "Le numéro doit contenir exactement 8 chiffres.";
      resultEl.classList.add("text-red-500");
      return;
    }

    loader.classList.remove("hidden");
    btnText.textContent = "Vérification...";

    try {
      const res = await fetch(`${API_URL}/api/vote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone: phone, candidate: "Candidat1", votes: 1 })
      });
      const data = await res.json();

      loader.classList.add("hidden");
      btnText.textContent = "Vérifier et Voter";

      if (data.success) {
        resultEl.textContent = data.message;
        resultEl.classList.remove("text-red-500");
        resultEl.classList.add("text-green-500");

        setTimeout(() => {
          window.location.href = "index.html";
        }, 1000);
      } else {
        resultEl.textContent = data.error || "Erreur lors du vote.";
        resultEl.classList.remove("text-green-500");
        resultEl.classList.add("text-red-500");
      }
    } catch (err) {
      loader.classList.add("hidden");
      btnText.textContent = "Vérifier et Voter";
      resultEl.textContent = "Erreur de connexion au serveur.";
      resultEl.classList.remove("text-green-500");
      resultEl.classList.add("text-red-500");
    }
  });
</script>
